<!DOCTYPE html>
<html>
<head>
    <title>CyberPath</title>
    <meta charset="UTF-8" />

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
    </script>

<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.0/dist/leaflet-routing-machine.css" />

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.0/dist/leaflet-routing-machine.js"></script>

    <link
        rel="stylesheet"
        href="{{ url_for('static', filename='style.css') }}"
    />
</head>

<body>
    <div id="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    </div>

    <div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                {% if category == 'change_password_error' %}
                    <div id="changePasswordError" data-message="{{ message }}"></div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    </div>

    <div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                {% if category == 'change_email_error' %}
                    <div id="changeEmailError" data-message="{{ message }}"></div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    </div>
        
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const err = document.getElementById("changePasswordError");
            if (err) {
                const popup = document.getElementById("changePasswordPopup");
                if (popup) popup.classList.remove("hidden");

                const profilePopup = document.getElementById("profilePopup");
                if (profilePopup) profilePopup.classList.add("hidden");
            }
        });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const err = document.getElementById("changeEmailError");
        if (err) {
            const popup = document.getElementById("changeEmailPopup"); 
            if (popup) popup.classList.remove("hidden");

            const profilePopup = document.getElementById("profilePopup");
            if (profilePopup) profilePopup.classList.add("hidden");
            }
        });
    </script>

    </div>

    <div id="content">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class = "sidebar-top">
                <h2>Cyberpath : MMU Smart <br/>Campus Navigator</h2>
                <ul>
                    <li>Faculty</li>
                    <li>Cafe</li>
                    <li>Lecture Rooms</li>
                    <li>Lab Rooms</li>
                </ul>
            </div>
            {% if not session.get("admin_logged_in") %}
            <button id="adminBtn" class="sign-inup">Admin Sign In/Sign Up</button>
            {% endif %}
            
        </div>

        <!-- Buttons -->
        <button id="toggleBtn">‚ò∞</button>
        <button id="centerBtn">Recentralize</button>
        <button id="gpsButton">üìç Find My Location</button>
        <button id="userRemoveRouteButton">Clear Route</button>

        <!-- Map container -->
        <div id="map-container">
            <div id="map"></div>
            <div id="coords-display">Click on the map to get coordinates</div>
        </div>

        <!-- Chatbot -->
        <div class="chatbot-icon">üí¨</div>

        <!-- Toggle admin sidebar -->
        <div id="adminSidebar" class="admin-sidebar" >
            <div class="admin-controls">
                <h2>Admin Dashboard</h2>
                <button class="admin-btn" id="addLocationBtn">Add Location</button>
                <button class="admin-btn" id="editLocationBtn">Edit Location</button>
                <button class="admin-btn" id="deleteLocationBtn">Delete Location</button>
                <button class="admin-btn" id="viewAllBtn">View All Locations</button>
            </div>
            <div id="signout-profile">
                {% if session.get("admin_logged_in") %}
                <form action="/signout" method="POST">
                    <button type ="submit" id="adminBtn" class="sign-out">Admin Sign Out</button>
                </form>
                {% endif %}

                <div class="profile-icon" id="profileBtn">üë§</div>
            </div>
        </div>

        <!--Add location container-->
        <div id="addLocationForm" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeAddLocation">&times;</span>
                <form id="markerForm" class="tab-form active" action="/add-marker" method="POST">
                    <h2>Add Location</h2>
                    
                    <label>Name:</label> <br>
                    <input type="text" id="locName" name="name"> <br> 

                    <label>Description:</label><br>
                    <input id="locDesc" name="description" required></input> <br>

                    <label>Location (lat, lng):</label><br>
                    <input type="text" id="locCoords" name="coords" placeholder="Click map or type manually">
                    <button type="button" id="pickFromMapBtn">Pick From Map</button><br>

                    <button type="submit" id="saveLocationBtn" class="admin-btn">Save</button>
                </form>
            </div>
        </div>

        <!--Edit location container-->
        <div id="editLocationListPopup" class="popup hidden">
            <div class="popup-content">
                <form class="close-btn" id="closeEditListPopup">&times;</form>
                <input type="text" id="searchEditLocation" class="popup-search" placeholder="Search location...">
                <div id="editLocationList" class="popup-list"></div>
            </div>
        </div>

        <!-- EDIT FORM POPUP IN CENTER -->
        <div id="editLocationFormPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeEditFormPopup">&times;</span>
                <h3>Edit Location</h3>

                <form id="editLocationForm" class="tab-form active" method="POST">
                    <label>Name:</label>
                    <input type="text" id="editLocName" name="name" required>

                    <label>Description:</label> 
                    <br>
                    <input id="editLocDesc" name="description" required></input>
                    <br>

                    <label>Location (lat, lng):</label>
                    <input type="text" id="editLocCoords" name="coords" placeholder="Click map or type manually">

                    <button type="button" id="editPickFromMapBtn" class="admin-btn">Pick From Map</button>
                    <button type="submit" class="admin-btn">Save Changes</button>
                </form>
            </div>
        </div>

        <!--Delete location container-->
        <div id="deleteLocationPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeDeletePopup" class="close-btn">&times;</span>

                <!-- Search bar -->
                <input type="text" id="searchDeleteLocation" class="popup-search" placeholder="Search locations...">

                <!-- Scrollable list -->
                <div id="deleteLocationList" class="popup-list"></div>
            </div>
        </div>

        <!-- View location container -->
        <div id="viewLocationPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closePopup" class="close-btn">&times;</span>
                <!-- Search bar -->
                <input type="text" id="searchLocation" class="popup-search" placeholder="Search locations...">
                <!-- Scrollable location list -->
                <div id="locationList" class="popup-list">
                    <!-- Items will appear here -->
                </div>
            </div>
        </div>
        
        <!--Profile container-->
        <div id="profilePopup" class ="popup hidden">
            <div class="popup-content">
                <span id="closeProfilePopup" class="close-btn">&times;</span>

                <h2>Admin Profile</h2>

                <!-- Profile Picture -->
                <div class="profile-picture-section">
                    <img id="profileImagePreview" src="" alt="Profile Picture">
                    <input type="file" id="profileImageInput" accept="image/*">
                </div>

                <!-- Info Fields -->

                <div class="profile-field">
                    <label>Email</label>
                    <input type="email" id="profileEmail" value="{{ user.email if user else '' }}" readonly>
                </div>


                <div class="profile-field">
                    <label>About Me: </label>
                    <textarea type="text" id="profileAboutMe" class="about-box" placeholder="Write sometthing about you."  value="{{ user.about_me or '' }}"></textarea>
                </div>

                <!-- Action Buttons -->
                <button id="changeEmailBtn" class="admin-btn">Change Email</button>
                <button id="changePasswordBtn" class="admin-btn">Change Password</button>

            </div>
        </div>

        <!-- Change Email Popup -->
        <div id="changeEmailPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeChangeEmailPopup" class="close-btn">&times;</span>

                <h2>Change Email</h2>

                <form id="changeEmailForm" class="tab-form active" method="POST" action="/change-email">
                    <label>New Email:</label>
                    <input type="email" id="newEmailInput" name="new_email" autocomplete="off" required>

                    <label>Current Password:</label>
                    <input type="password" id="confirmEmailpassword" name="password" autocomplete="off" required>

                    <button id="confirmChangeEmailBtn" class="admin-btn">Confirm</button>
                </form>
            </div>
        </div>

        <!-- Change Password Popup -->
        <div id="changePasswordPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeChangePasswordPopup" class="close-btn">&times;</span>

                <h2>Change Password</h2>

                <form id="changePasswordForm" class="tab-form active" method="POST" action="/changepassword">

                    <label>Current Password:</label>
                    <input type="password" id="curPasswordInput" name="current_password" required autofill="off">

                    <label>New Password:</label>
                    <input type="password" id="newPasswordInput" name="new_password" required autofill="off">

                    <label>Confirm Password:</label>
                    <input type="password" id="confirmPasswordInput" name="confirm_password" required autofill="off">

                    <button type="submit" id="confirmChangePasswordBtn" class="admin-btn">Confirm</button>
                </form>

            </div>
        </div>



        <!-- Toggle admin dashboard button -->
            {% if session.get('admin_logged_in') %}
                <button id="adminToggleBtn" class="admin-toggle-btn">‚ò∞ Admin</button>
            {% endif %}

        <!-- Admin Sign In/Sign Up Popup -->
        {% if not session.get("admin_logged_in") %}
        <div id="adminPopup" class="popup-overlay">
            <div class="popup-content">
                <span id="closePopup" class="close-btn"></span>

                <!-- Tabs -->
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="signin">Sign In</button>
                    <button class="tab-btn" data-tab="signup">Sign Up</button>
                </div>

                <!-- Sign In Form -->
                <form id="signinForm" class="tab-form active"  action="/signin" method="POST" >
                    <label for="signinEmail">Email:</label>
                    <input type="email" id="signinEmail" name="email" required>

                    <label for="password">Password:</label>
                    <input type="password" id="signinPassword" name="password" required>

                    <button type="submit">Sign In</button>
                    <button type="button" id="forgotPasswordBtn">Frogot Passsword</button>
                </form>

                <!-- Sign Up Form -->
                <form id="signupForm" class="tab-form"  action="/signup" method="POST">
                
                    <label for="email">Email:</label>
                    <input type="email" id="signupEmail" name="email" required>

                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" name="password" required>

                    <button type="submit">Sign Up</button>
                </form>

            </div>
        </div>
        {% endif %}
        
        <!--Forgot password-->
        <div id="forgotPasswordPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeForgotPasswordPopup" class="close-btn">&times;</span>

                <h2>Change Password</h2>
                <form id="forgotPasswordForm" class="tab-form active" method="POST" action="/forgot-password">

                    <label>Email:</label>
                    <input type="email" id="forgotEmailInput" name="email" autocomplete="off" required>

                    <label>New Password:</label>
                    <input type="password" id="newPasswordInput" name="password" autocomplete="new-password" required>

                    <label>Confirm Password:</label>
                    <input type="password" id="confirmPasswordInput" name="c_password" autocomplete="new-password" required>

                    <button type="submit" id="confirmForgotPasswordBtn" class="admin-btn">Confirm</button>

                </form>
            </div>
        </div>
    </div>


    <script src="{{ url_for('static', filename='routing.js') }}"></script>
    <script src="{{ url_for('static', filename='gps.js') }}"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>


</body>
</html>
