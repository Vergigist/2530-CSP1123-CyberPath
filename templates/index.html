<!DOCTYPE html>
<html>
<head>
    <title>CyberPath</title>
    <meta charset="UTF-8" />

   <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        />


    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
    </script>

<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <link
        rel="stylesheet"
        href="{{ url_for('static', filename='style.css') }}"
    />
</head>

<body>
    <div id="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    </div>

    <div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                {% if category == 'change_password_error' %}
                    <div id="changePasswordError" data-message="{{ message }}"></div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    </div>

    <div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                {% if category == 'change_email_error' %}
                    <div id="changeEmailError" data-message="{{ message }}"></div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const err = document.getElementById("changePasswordError");
            if (err) {
                const popup = document.getElementById("changePasswordPopup");
                if (popup) popup.classList.remove("hidden");

                const profilePopup = document.getElementById("profilePopup");
                if (profilePopup) profilePopup.classList.add("hidden");
            }
        });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const err = document.getElementById("changeEmailError");
        if (err) {
            const popup = document.getElementById("changeEmailPopup"); 
            if (popup) popup.classList.remove("hidden");

            const profilePopup = document.getElementById("profilePopup");
            if (profilePopup) profilePopup.classList.add("hidden");
            }
        });
    </script>

    <div id="content">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class = "sidebarTop">
                <img src="https://www.mmu.edu.my/wp-content/themes/mmu2018/assets/images/logo-mmu2x.png">
                <h2>Cyberpath : Smart <br/>Campus Navigator</h2>
                <button class="user-btn" id="gpsButton">üìç Find My Location</button>
                <button class="user-btn" id="viewAllBtnUser">View Locations</button>
                <button class="user-btn" id="userRemoveRouteButton">Clear Route</button>
                <button class="user-btn" id="centerBtn">Recentralize</button>
                <button class="user-btn" id="submitFeedback">Feedback</button>
            </div>
            <div id="sidebarBottom">
                {% if not session.get("admin_logged_in") %}
                <button id="adminBtn" class="sign-inup">Admin Sign In/Sign Up</button>
                {% endif %}
            </div>
        </div>

        <!-- Buttons -->
        <button id="toggleBtn">‚ò∞</button>

        <!-- Map container -->
        <div id="map-container">
            <div id="map"></div>
            <div id="coords-display">Click on the map to get coordinates</div>
            
            <!-- Indoor overlay -->
            <div id="indoorContainer" hidden>
                <img id="floorImage">
            </div>
        </div>

        <!-- Chatbot -->
        <div class="chatbot-icon">üí¨</div>
        <!-- Chatbot Popup -->
        <div id="chatbotPopup" class="popup hidden">
            <div class="popup-content" style="width: 400px; height: 500px; display: flex; flex-direction: column;">
                <span id="closeChatbotPopup" class="close-btn">&times;</span>
                
                <h3 style="margin: 0 0 15px 0;">Campus Assistant ü§ñ</h3>
                
                <!-- Chat messages area -->
                <div id="chatMessages" style="flex: 1; overflow-y: auto; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                    <!--Message from bot -->
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #2196f3;">
                        <strong>Assistant:</strong> Hello! I'm your campus AI assistant. Ask me about locations, directions, or anything about MMU campus!
                    </div>
                </div>
                
                <!-- Chat input area -->
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Type your question here..." 
                        style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"
                        autocomplete="off">
                    <button id="sendChatBtn" class="admin-btn" style="padding: 10px 20px;">Send</button>
                </div>
            </div>
        </div>

        <!-- Toggle admin sidebar -->
        <div id="adminSidebar" class="admin-sidebar" >
            <div class="admin-controls">
                <h2>Admin Dashboard</h2>
                <button class="admin-btn" id="addLocationBtn">Add Location</button>
                <button class="admin-btn" id="editLocationBtn">Edit Location</button>
                <button class="admin-btn" id="deleteLocationBtn">Delete Location</button>
                <button class="admin-btn" id="viewAllBtn">View All Locations</button>
                <button class="admin-btn" id="pendingApprovalsBtn">Pending Approvals</button>
                <button class="admin-btn" id="manageAdminsBtn">Manage Admins</button>
                <button class="admin-btn" id="viewFeedbackBtn">View Reports</button>
            </div>
            <div id="signout-profile">
                {% if session.get("admin_logged_in") %}
                <form action="/signout" method="POST">
                    <button type ="submit" id="adminBtn" class="sign-out">Admin Sign Out</button>
                </form>
                {% endif %}

                <div class="profile-icon" id="profileBtn">üë§</div>
            </div>
        </div>

        <!--Add location container-->
        <div id="addLocationForm" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeAddLocation">&times;</span>
                <form id="markerForm" class="tab-form active" action="/add-marker" method="POST">
                    <h2>Add Location</h2>
                    
                    <label>Name:</label> <br>
                    <input type="text" id="locName" name="name" autocomplete="new-password"> <br> 

                    <label>Description:</label><br>
                    <input id="locDesc" name="description" required autocomplete="new-password"></input> <br>

                    <label>Category:</label> <br>
                    <select class="admin-btn" id="category" name="category_id" required>
                        <option value="">Select category</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select> <br>
                    <br>
                    <label>Location (lat, lng):</label><br>
                    <input type="text" id="locCoords" name="coords" placeholder="Click map or type manually" autocomplete="new-password">
                    <button type="button" id="pickFromMapBtn">Pick From Map</button><br>

                    <button type="submit" id="saveLocationBtn" class="admin-btn">Save</button>
                </form>
            </div>
        </div>

        <!--Edit location container-->
        <div id="editLocationListPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeEditListPopup">&times;</span>
                <input type="text" id="searchEditLocation" class="popup-search" placeholder="Search location...">
                <div id="editLocationList" class="popup-list"></div>
            </div>
        </div>

        <!-- EDIT FORM POPUP IN CENTER -->
        <div id="editLocationFormPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeEditFormPopup">&times;</span>
                <h3>Edit Location</h3>

                <form id="editLocationForm" class="tab-form active" method="POST">
                    <label>Name:</label>
                    <input type="text" id="editLocName" name="name" required autocomplete="new-password">

                    <label>Description:</label> 
                    <br>
                    <input id="editLocDesc" name="description" required autocomplete="new-password"></input>
                    <br>

                    <label>Category:</label> <br>
                    <select class="admin-btn" id="editCategory" name="category_id" required>
                        <option value="">Select category</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select> <br>

                    <label>Location (lat, lng):</label>
                    <input type="text" id="editLocCoords" name="coords" placeholder="Click map or type manually" autocomplete="new-password">

                    <button type="button" id="editPickFromMapBtn" class="admin-btn">Pick From Map</button>
                    <button type="submit" class="admin-btn">Save Changes</button>
                </form>
            </div>
        </div>

        <!--Delete location container-->
        <div id="deleteLocationPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeDeletePopup" class="close-btn">&times;</span>

                <!-- Search bar -->
                <input type="text" id="searchDeleteLocation" class="popup-search" placeholder="Search locations...">
                <div class="popup-row header">
                    <span>Name</span>
                    <span></span>
                    <span></span>
                    <span>Action</span>
                </div>

                <!-- Scrollable list -->
                <div id="deleteLocationList" class="popup-list"></div>
            </div>
        </div>

        <!-- View location container -->
        <div id="viewLocationPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closePopup" class="close-btn">&times;</span>
                
                <input type="text" id="searchLocation" class="popup-search" placeholder="Search locations...">
                
                <!-- List header -->
                <div class="popup-row header">
                    <span>Name</span>
                    <span>Category</span>
                    <span>Action</span>
                    <span></span>
                </div>
                
                <div id="locationList" class="popup-list">
                    <!-- Items will appear here -->
                </div>
            </div>
        </div>

        <div id="pendingApprovalsPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closePendingApprovals" class="close-btn">&times;</span>
                <h2>Pending Approvals</h2>
                <input type="text" id="searchLocation" class="popup-search" placeholder="Search Email...">
                <div class="popup-row header">
                    <span>Name</span>
                    <span></span>
                    <span>Action</span>
                    <span></span>
                </div>
                <div id="pendingApprovalsList" class="popup-list">
                    <!-- Pending approvals list here -->
                </div>
            </div>
        </div>

        <div id="manageAdminsPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeManageAdmins" class="close-btn">&times;</span>
                <h2>Manage Admins</h2>
                <input type="text" id="searchLocation" class="popup-search" placeholder="Search Admin...">
                <div class="popup-row header">
                    <span>Name</span>
                    <span></span>
                    <span></span>
                    <span>Action</span>
                </div>
                <div id="adminsList" class="popup-list">
                    <!-- Admins list here or whatever-->
                </div>
            </div>
        </div>

        <div id="viewFeedbackPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeViewFeedbackPopup" class="close-btn">&times;</span>
                
                <!--View Reports list-->
                <div class="tab-header">
                    <button id="viewFeedbackTabBtn" class="tab-btn active">View Feedback</button>
                    <button id="viewHistoryTabBtn" class="tab-btn">View History</button>
                </div>
                
                <h2 id="popupTitle">View Feedback</h2>
                <input type="text" id="searchLocation" class="popup-search" placeholder="Search feedbacks...">
                <div class="popup-row header">
                    <span>Name</span>
                    <span></span>
                    <span></span>
                    <span>Action</span>
                </div>
                <div class="popup-list" id="feedbackList">
                    <!--Reports list here-->
                </div>
            </div>
        </div>
        
        <div id="feedbackPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeFeedbackPopup" class="close-btn">&times;</span>
                <form id="feedbackForm" class="tab-form active" method="POST" action="/feedback">
                    <h2>Feedback</h2>

                    <label>Subject:</label>
                    <input type="text" name="subject" autocomplete="new-password" required>

                    <label>Description:</label>
                    <textarea class="about-box" name="description"></textarea>

                    <button id="confirmSubmitFeedback" class="user-btn">Submit Feedback</button>
                </form>
            </div>
        </div>

        <div id="feedbackDetailsPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeFeedbackDetailsPopup" class="close-btn">&times;</span>
                <div class="tab-form active">
                    <h2>Feedback Details</h2>

                    <label>Subject:</label>
                    <input type="text" id="feedbackSubject" readonly>

                    <label>Time Submitted:</label>
                    <input type="text" id="feedbackTimeSubmitted" readonly>

                    <label>Description:</label>
                    <textarea id="feedbackDescription" class="about-box" readonly></textarea>

                    <div class="tab-header">
                        <button id="approveFeedbackBtn" class="admin-btn">Approve</button>
                        <button id="ignoreFeedbackBtn" class="admin-btn">Ignore</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Profile container-->
        <div id="profilePopup" class ="popup hidden">
            <div class="popup-content">
                <span id="closeProfilePopup" class="close-btn">&times;</span>

                <h2>Admin Profile</h2>

                <!-- Profile Picture -->
                <div class="profile-picture-section">
                    <img id="profileImagePreview" src="" alt="Profile Picture">
                    <input type="file" id="profileImageInput" accept="image/*">
                </div>

                <!-- Info Fields -->

                <div class="profile-field">
                    <label>Email</label>
                    <input type="email" id="profileEmail" value="{{ user.email if user else '' }}" readonly>
                </div>


                <div class="profile-field">
                    <label>About Me: </label>
                    <textarea id="profileAboutMe" class="about-box" spellcheck="false" placeholder="Write something about you.">{{ user.about_me or '' }}</textarea>
                    <small id="aboutStatus" style="opacity:0; transition: opacity 0.3s;"></small>
                </div>

                <!-- Action Buttons -->
                <button id="changeEmailBtn" class="admin-btn">Change Email</button>
                <button id="changePasswordBtn" class="admin-btn">Change Password</button>

            </div>
        </div>

        <!-- Change Email Popup -->
        <div id="changeEmailPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeChangeEmailPopup" class="close-btn">&times;</span>

                <h2>Change Email</h2>

                <form id="changeEmailForm" class="tab-form active" method="POST" action="/change-email">
                    <label>New Email:</label>
                    <input type="email" id="newEmailInput" name="new_email" autocomplete="new-password" required>

                    <label>Current Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirmEmailpassword" name="password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <button id="confirmChangeEmailBtn" class="admin-btn">Confirm</button>
                </form>
            </div>
        </div>

        <!-- Change Password Popup -->
        <div id="changePasswordPopup" class="popup hidden">
            <div class="popup-content">
                <span id="closeChangePasswordPopup" class="close-btn">&times;</span>

                <h2>Change Password</h2>

                <form id="changePasswordForm" class="tab-form active" method="POST" action="/changepassword">

                    <label>Current Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="curPasswordInput" name="current_password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <label>New Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="newPasswordInput" name="new_password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <label>Confirm Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirmPasswordInput" name="confirm_password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <button type="submit" id="confirmChangePasswordBtn" class="admin-btn">Confirm</button>
                </form>

            </div>
        </div>



        <!-- Toggle admin dashboard button -->
            {% if session.get('admin_logged_in') %}
                <button id="adminToggleBtn" class="admin-toggle-btn">‚ò∞ Admin</button>
            {% endif %}

        <!-- Admin Sign In/Sign Up Popup -->
        {% if not session.get("admin_logged_in") %}
        <div id="adminPopup" class="popup-overlay">
            <div class="popup-content">
                <span id="closePopup" class="close-btn"></span>

                <!-- Tabs -->
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="signin">Sign In</button>
                    <button class="tab-btn" data-tab="signup">Sign Up</button>
                </div>

                <!-- Sign In Form -->
                <form id="signinForm" class="tab-form active"  action="/signin" method="POST" >

                    <label for="signinEmail">Email:</label>
                    <input type="email" id="signinEmail" name="email" autocomplete="new-password" required>

                    <label for="password">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="signinPassword" name="password" class="password-field" autocomplete="new-password" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <button type="submit">Sign In</button>
                    <button type="button" id="forgotPasswordBtn">Forgot Passsword</button>
                </form>

                <!-- Sign Up Form -->
                <form id="signupForm" class="tab-form"  action="/signup" method="POST">
                    
                    <label>Referral Code:</label>
                    <input type="text" id="referral" name="referral" autocomplete="new-password" required>
                    <span id="referralError" class="error-message"></span> 

                    <label for="email">Email:</label>
                    <input type="email" id="signupEmail" name="email" autocomplete="new-password" required>
                    <span id="emailError" class="error-message"></span>

                    <label for="signupPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="signupPassword" name="password" class="password-field" autocomplete="new-password" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>
                    <span id="passwordError" class="error-message"></span>

                    <button type="submit">Sign Up</button>
                </form>

                <div id="flashedMessages" style="display:none;">
                    {{ get_flashed_messages(with_categories=true) | tojson }}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!--Forgot password-->
        <div id="forgotOtpPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeForgotOtp">&times;</span>
                <h2>Forgot Password</h2>

                <form id="sendOtpForm" class="tab-form active">
                <label>Email</label>
                <input type="email" name="email" required autocomplete="new-password">
                <button id="sendOtpBtn" type="submit" class="admin-btn">Send OTP</button>
                </form>
            </div>
        </div>
        <div id="verifyOtpPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close-btn" id="closeVerifyOtp">&times;</span>
                <h2>Reset Password</h2>

                <form id="verifyOtpForm" class ="tab-form active" method="POST" action="/forgot-password/verify">

                    <label>OTP:</label>
                    <input type="hidden" name="otp" id="otpHidden">

                    <div class="otp-boxes">
                        <input type="text" maxlength="1" class="otp-input">
                        <input type="text" maxlength="1" class="otp-input">
                        <input type="text" maxlength="1" class="otp-input">
                        <input type="text" maxlength="1" class="otp-input">
                        <input type="text" maxlength="1" class="otp-input">
                        <input type="text" maxlength="1" class="otp-input">
                    </div>

                    <label>New Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="otpNewPassword" name="password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i> <br>
                    </div>

                    <label>Confirm Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="otpConfirmPassword" name="confirm_password" class="password-field" required>
                        <i class="fa-solid fa-eye-slash toggle-password"></i>
                    </div>

                    <button type="submit">Reset Password</button>
                </form>

            </div>
        </div>

        <div id="indoorPanel">
            <h2>FCI Building</h2>
            <button onclick="loadFloor(4)">Floor 4</button>
            <button onclick="loadFloor(3)">Floor 3</button>
            <button onclick="loadFloor(2)">Floor 2</button>
            <button onclick="loadFloor(1)">Floor 1</button>
            <button onclick="loadFloor(0)">Ground</button>
            <button onclick="exitIndoor()">Exit Building</button>
        </div>


    </div>
    <script src="{{ url_for('static', filename='routing.js') }}"></script>
    <script src="{{ url_for('static', filename='gps.js') }}"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="{{ url_for('static', filename='indoor.js') }}"></script>
    <script src="{{ url_for('static', filename='chatbot.js') }}"></script>



</body>
</html>
